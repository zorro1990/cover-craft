# Epic 4: 社区与分享 (Phase 4)

## Epic 概述

**目标**: 建立用户生态，通过模板和素材共享，增强产品吸引力和用户粘性。

**价值**: 让用户可以分享作品、获取灵感、复用优质模板，形成自增长的社区生态。

**验收标准**:
- [ ] 支持生成唯一 URL 分享设计
- [ ] 模板库包含至少 100 个模板
- [ ] 素材库包含至少 1000 个素材
- [ ] 分享链接加载时间 < 2 秒
- [ ] 支持匿名分享（无需注册）

---

## 用户故事

### Story 4.1: 数据库后端配置

**故事 ID**: US-401
**优先级**: P0 (最高)
**故事点**: 3

#### 用户故事

作为 **开发者**，我需要 **配置 Vercel Postgres 数据库**，以便 **存储用户分享的设计和模板数据**。

#### 验收标准

**场景 1: 数据库初始化**
- [ ] 在 Vercel 项目中启用 Postgres 数据库
- [ ] 创建必要的数据库表结构
- [ ] 设置数据库访问权限
- [ ] 配置数据库连接池

**场景 2: 表结构设计**
- [ ] `designs` 表：存储设计稿（id, userId, content, isPublicTemplate, createdAt, previewUrl, name）
- [ ] `shared_materials` 表：存储共享素材（id, userId, imageUrl, type, tags, createdAt）
- [ ] `templates` 表：存储模板（与 designs 关联，isPublicTemplate=true 的 designs）
- [ ] 所有表包含审计字段（created_at, updated_at）

**场景 3: 数据库连接**
- [ ] 在应用中配置数据库连接
- [ ] 使用环境变量存储数据库 URL
- [ ] 连接池配置合理（最小 5，最大 100）
- [ ] 支持连接超时和重试

**场景 4: 索引优化**
- [ ] 为常用查询字段添加索引
- [ ] `designs` 表：为 userId、createdAt、isPublicTemplate 添加索引
- [ ] `shared_materials` 表：为 userId、type、tags 添加索引
- [ ] 索引命名规范（idx_table_column）

**场景 5: 数据备份**
- [ ] 配置自动备份（每日）
- [ ] 设置备份保留期（30 天）
- [ ] 提供手动备份功能
- [ ] 记录备份状态和日志

#### 技术任务

- [ ] 设计和创建数据库表结构
- [ ] 配置 Vercel Postgres
- [ ] 实现数据库连接池
- [ ] 创建数据库迁移脚本
- [ ] 添加数据库操作封装
- [ ] 实现数据库监控和日志
- [ ] 编写数据库测试

#### 工作量估算

**数据库设计**: 1 天
**后端开发**: 2 天
**测试**: 1 天
**总计**: 4 天

---

### Story 4.2: 网页分享

**故事 ID**: US-402
**优先级**: P0 (最高)
**故事点**: 8

#### 用户故事

作为 **创作者**，我想要 **生成一个唯一的 URL 链接**，以便 **将我的设计稿分享给他人查看**。

#### 验收标准

**场景 1: 生成分享链接**
- [ ] 用户完成设计后，点击顶部工具栏"分享"按钮
- [ ] 弹出分享对话框
- [ ] 用户可以输入设计标题（可选）
- [ ] 点击"生成分享链接"按钮
- [ ] 系统生成唯一 URL（如：cover.qiaomu.ai/share/DVlejG）

**场景 2: 链接管理**
- [ ] 生成的链接显示在对话框中
- [ ] 提供"复制链接"按钮
- [ ] 显示链接二维码（方便手机扫描）
- [ ] 提供"打开预览"链接
- [ ] 链接创建时间显示在对话框中

**场景 3: 分享页面**
- [ ] 任何人都可以通过链接访问分享页面
- [ ] 分享页面加载时间 < 2 秒
- [ ] 页面显示完整的设计内容
- [ ] 页面显示设计标题和创建时间
- [ ] 页面响应式设计（手机和电脑都能正常查看）

**场景 4: 分享页面功能**
- [ ] 页面提供"复制图片"按钮（复制设计到剪贴板）
- [ ] 页面提供"在编辑器中打开"按钮（跳转回编辑器并加载设计）
- [ ] 页面提供"点赞"按钮（统计点赞数）
- [ ] 页面提供"下载 PNG"按钮
- [ ] 页面显示访问次数

**场景 5: 设计数据存储**
- [ ] 设计数据以 JSON 格式存储在数据库
- [ ] 包含完整的 Fabric.js 画布数据
- [ ] 图片以 URL 形式存储（CDN 或第三方存储）
- [ ] 存储设计创建时间、最后修改时间
- [ ] 支持匿名分享（无需用户登录）

**场景 6: 链接有效性**
- [ ] 链接永久有效（不设置过期时间）
- [ ] 删除设计时，链接自动失效
- [ ] 提供"失效链接"提示页面
- [ ] 支持链接别名（可选）

**场景 7: 性能优化**
- [ ] 分享页面使用静态生成（SSG）
- [ ] 图片使用 CDN 加速
- [ ] 数据压缩存储
- [ ] 访问日志记录和分析

#### 技术任务

- [ ] 创建分享 API 端点（POST /api/share）
- [ ] 创建分享页面路由（/share/[id]）
- [ ] 实现数据库存储设计
- [ ] 生成唯一 ID 算法
- [ ] 创建分享对话框组件
- [ ] 实现分享页面 UI
- [ ] 添加访问统计功能
- [ ] 实现图片 CDN
- [ ] 编写分享功能测试

#### 工作量估算

**前端开发**: 4 天
**后端开发**: 3 天
**测试**: 2 天
**总计**: 9 天

---

### Story 4.3: 模板共享

**故事 ID**: US-403
**优先级**: P0 (最高)
**故事点**: 8

#### 用户故事

作为 **创作者**，我想要 **将我的设计共享为模板**，以便 **其他用户可以参考和使用我的设计**。

#### 验收标准

**场景 1: 另存为模板**
- [ ] 用户完成满意的设计后，点击顶部"另存为模板"
- [ ] 弹出模板保存对话框
- [ ] 用户输入模板名称（必填）
- [ ] 用户输入模板描述（可选）
- [ ] 用户选择模板分类：商务、节日、简约、创意等

**场景 2: 模板属性设置**
- [ ] 用户可以选择模板是否公开
- [ ] 公开模板：其他用户可以搜索和使用
- [ ] 私有模板：仅自己可见
- [ ] 默认设置为公开
- [ ] 提供预览图自动生成

**场景 3: 保存模板**
- [ ] 用户点击"保存"按钮
- [ ] 系统生成设计预览图
- [ ] 将设计数据保存到数据库（isPublicTemplate=true）
- [ ] 保存成功后显示"模板保存成功"提示
- [ ] 模板自动添加到"我的模板"列表

**场景 4: 浏览模板库**
- [ ] 用户点击左侧面板"模板"按钮
- [ ] 显示"公共模板"标签页（默认）
- [ ] 模板以卡片形式展示
- [ ] 每个模板显示：预览图、名称、作者、使用次数
- [ ] 提供分类筛选：全部、商务、节日、简约、创意等

**场景 5: 搜索和排序**
- [ ] 顶部提供搜索框
- [ ] 用户可以按模板名称搜索
- [ ] 提供排序选项：最新、最热、使用最多、评分最高
- [ ] 提供筛选条件：分类、作者
- [ ] 搜索响应时间 < 500ms

**场景 6: 使用模板**
- [ ] 用户点击模板卡片
- [ ] 显示模板预览对话框
- [ ] 预览显示完整设计内容
- [ ] 用户点击"使用此模板"按钮
- [ ] 模板内容加载到画布
- [ ] 用户可以修改模板内容

**场景 7: 我的模板**
- [ ] 模板面板显示"我的模板"标签页
- [ ] 显示用户创建的所有模板
- [ ] 每个模板显示编辑和删除按钮
- [ ] 提供编辑功能：修改名称、描述、分类
- [ ] 删除模板前显示确认对话框

**场景 8: 模板统计**
- [ ] 每个模板显示使用次数
- [ ] 显示模板创建时间
- [ ] 显示点赞数量
- [ ] 创作者可以查看模板的详细统计

#### 技术任务

- [ ] 创建模板保存 API 端点（POST /api/template）
- [ ] 实现模板数据库存储
- [ ] 创建模板面板组件
- [ ] 实现模板预览图生成
- [ ] 添加模板搜索和筛选
- [ ] 实现模板使用功能
- [ ] 添加模板统计功能
- [ ] 实现模板管理（编辑、删除）
- [ ] 编写模板功能测试

#### 工作量估算

**前端开发**: 5 天
**后端开发**: 3 天
**测试**: 2 天
**总计**: 10 天

---

### Story 4.4: 素材共享

**故事 ID**: US-404
**优先级**: P1 (高)
**故事点**: 8

#### 用户故事

作为 **创作者**，我想要 **将我上传的或 AI 处理的图片共享为素材**，以便 **其他用户可以使用我的创意素材**。

#### 验收标准

**场景 1: 共享为素材**
- [ ] 用户在个人图库中选择图片
- [ ] 点击"共享为素材"按钮
- [ ] 弹出素材共享对话框
- [ ] 用户输入素材名称（必填）
- [ ] 用户选择素材类型：
  - Meme 图：搞笑、有趣的图片
  - 透明图：去背景后的 PNG 图片
  - 其他：其他类型素材

**场景 2: 标签设置**
- [ ] 用户可以添加标签（最多 10 个）
- [ ] 提供常用标签建议
- [ ] 标签格式：#关键词（如 #可爱 #卡通 #简约）
- [ ] 用户可以选择是否公开
- [ ] 默认设置为公开

**场景 3: 素材验证**
- [ ] 系统检查图片质量（尺寸、清晰度）
- [ ] 图片尺寸最小：256x256
- [ ] 图片大小最大：5MB
- [ ] 支持格式：JPG、PNG、WebP
- [ ] 不符合要求的图片显示错误提示

**场景 4: 保存素材**
- [ ] 用户点击"共享"按钮
- [ ] 系统将图片上传到云存储（Vercel Blob 或 S3）
- [ ] 图片 URL 和元数据保存到数据库
- [ ] 保存成功后显示"素材共享成功"提示
- [ ] 素材自动添加到"我的共享素材"列表

**场景 5: 素材库浏览**
- [ ] 用户点击左侧面板"共享素材"按钮
- [ ] 显示公共素材库（所有用户共享的素材）
- [ ] 素材以网格形式展示
- [ ] 每个素材显示：缩略图、名称、标签、作者、使用次数
- [ ] 提供分类筛选：全部、Meme 图、透明图、其他

**场景 6: 素材搜索**
- [ ] 顶部提供搜索框
- [ ] 用户可以按素材名称搜索
- [ ] 用户可以按标签搜索（#可爱）
- [ ] 用户可以按作者搜索
- [ ] 搜索结果实时显示

**场景 7: 使用素材**
- [ ] 用户点击素材显示预览
- [ ] 预览对话框显示素材大图
- [ ] 显示素材信息：名称、标签、作者、创建时间
- [ ] 用户点击"使用此素材"按钮
- [ ] 素材添加到画布

**场景 8: 我的共享**
- [ ] 显示"我的共享"标签页
- [ ] 显示用户共享的所有素材
- [ ] 每个素材显示：使用次数、点赞数、举报数
- [ ] 提供编辑功能：修改名称、标签
- [ ] 提供删除功能（删除前确认）

**场景 9: 素材管理**
- [ ] 素材库支持批量操作
- [ ] 用户可以批量删除自己的素材
- [ ] 提供素材举报功能（不当内容）
- [ ] 被举报次数多的素材可能下架
- [ ] 管理员可以审核和管理素材

#### 技术任务

- [ ] 创建素材共享 API 端点
- [ ] 实现素材数据库存储
- [ ] 集成云存储服务
- [ ] 创建素材库面板组件
- [ ] 实现素材搜索和筛选
- [ ] 实现素材使用功能
- [ ] 添加标签系统
- [ ] 实现素材管理（编辑、删除）
- [ ] 添加素材统计和举报功能
- [ ] 编写素材功能测试

#### 工作量估算

**前端开发**: 5 天
**后端开发**: 3 天
**云存储**: 1 天
**测试**: 2 天
**总计**: 11 天

---

## Epic 4 总结

### 开发计划

| 故事 | 优先级 | 故事点 | 开发时间 |
|------|--------|--------|----------|
| US-401 数据库配置 | P0 | 3 | 4 天 |
| US-402 网页分享 | P0 | 8 | 9 天 |
| US-403 模板共享 | P0 | 8 | 10 天 |
| US-404 素材共享 | P1 | 8 | 11 天 |
| **总计** | | **27** | **34 天** |

### 迭代规划

**迭代 1** (4 天): US-401 数据库配置
- 配置 Vercel Postgres
- 创建数据库表结构
- 实现基础连接和操作

**迭代 2** (9 天): US-402 网页分享
- 实现分享链接生成
- 创建分享页面
- 实现设计数据存储

**迭代 3** (10 天): US-403 模板共享
- 实现模板保存和浏览
- 添加搜索和筛选
- 实现模板使用功能

**迭代 4** (11 天): US-404 素材共享
- 实现素材共享功能
- 添加标签和分类
- 实现素材库管理

### 依赖关系

- US-401（数据库）是所有其他功能的基础
- US-402（网页分享）依赖 US-401 完成
- US-403（模板共享）依赖 US-401、US-402 完成
- US-404（素材共享）依赖 US-401 完成

### 风险评估

**高风险**:
- 数据库性能和扩展性
- 云存储成本和限制
- 内容审核和版权问题
- 恶意用户和垃圾内容

**中风险**:
- 分享链接安全性
- 素材质量和合规性
- 移动端加载性能
- 社区生态冷启动

**低风险**:
- 基础数据库操作
- UI 交互功能

### 技术里程碑

- **里程碑 1**: 数据库系统上线 ✅ (迭代 1)
- **里程碑 2**: 网页分享功能上线 ✅ (迭代 2)
- **里程碑 3**: 模板共享功能上线 ✅ (迭代 3)
- **里程碑 4**: 素材共享功能上线 ✅ (迭代 4)
- **里程碑 5**: 社区生态初步建立（100+ 模板） ✅
- **里程碑 6**: Phase 4 完成，产品正式发布 ✅

### 关键指标

- 分享链接生成数量：每日 > 100
- 模板库模板数量：> 100
- 素材库素材数量：> 1000
- 分享链接平均加载时间：< 2 秒
- 模板使用转化率：> 30%
- 用户留存率（7 天）：> 40%

### 社区运营策略

**内容冷启动**:
- 团队创建 20 个高质量模板
- 邀请种子用户贡献模板
- 定期举办模板创作比赛

**用户激励**:
- 模板使用量排行榜
- 优秀模板推荐位
- 创作者认证标识

**内容质量保障**:
- 素材自动审核
- 用户举报机制
- 社区准则制定
